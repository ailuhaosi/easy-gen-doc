import{a as d}from"./axios.4378cf49.js";import{_ as m}from"./_plugin-vue_export-helper.cdc0426e.js";import{g as p,h as f,n as b,o as _,c as v,a as h,d as g}from"./app.71d40c05.js";const a=(i,t="",e="",s="")=>(t&&(i+=`-${t}`),e&&(i+=`__${e}`),s&&(i+=`--${s}`),i),$=i=>({b:(t="")=>a(i,t),e:(t="")=>t?a(i,"",t):"",m:(t="")=>t?a(i,"","",t):"",be:(t="",e="")=>t&&e?a(i,t,e):"",bm:(t="",e="")=>t&&e?a(i,t,"",e):"",em:(t="",e="")=>t&&e?a(i,"",t,e):"",bem:(t="",e="",s="")=>t&&e&&s?a(i,t,e,s):"",is:(t,e)=>e?`is-${t}`:""}),x=i=>{const t=`k-${i}`;return $(t)};var k=Object.defineProperty,w=(i,t,e)=>t in i?k(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e,r=(i,t,e)=>(w(i,typeof t!="symbol"?t+"":t,e),e);const c=x("comment"),y=d.create({baseURL:"https://gitee.com/"}),l=async i=>{const{data:t}=await y(i);return t};class L{constructor(t){r(this,"userInfo",null),r(this,"el",null),r(this,"textarea",document.createElement("textarea")),r(this,"button",document.createElement("button")),r(this,"ul",document.createElement("ul")),r(this,"list",[]),r(this,"number",""),this.options=t}async init(){var t,e,s;this.textarea=document.createElement("textarea"),this.ul=document.createElement("ul"),this.button=document.createElement("button"),this.list=[],this.number="";const o=(s=(e=(t=location.search.match(/code=[^&]+/))==null?void 0:t[0])==null?void 0:e.split("="))==null?void 0:s[1];o&&await this.getToken(o);const n=JSON.parse(localStorage.getItem("comment"));if(!n){!o&&await this.getList();return}+new Date(n.expires_in+n.created_at)*1e3>Date.now()?(this.userInfo=n,await this.getList()):+new Date(n.expires_in+n.created_at)*1e3+864e5>Date.now()&&await this.refreshToken()}login(){location.href=`https://gitee.com/oauth/authorize?client_id=${this.options.client_id}&redirect_uri=${location.origin}&response_type=code`}async getToken(t){const e=await l({method:"post",url:"/oauth/token",params:{grant_type:"authorization_code",code:t,client_id:this.options.client_id,redirect_uri:location.origin},data:{client_secret:this.options.client_secret}});history.pushState({},"",location.href.replace(location.search,"")),localStorage.setItem("comment",JSON.stringify(e)),this.userInfo=e,this.button.innerHTML=this.userInfo?"\u53D1\u8868\u8BC4\u8BBA":"\u4F7F\u7528 Gitee \u767B\u5F55",this.button.disabled=!!this.userInfo,await this.getList()}async refreshToken(){var t;const e=(t=this.userInfo)==null?void 0:t.refresh_token;localStorage.removeItem("comment"),await l({url:"/oauth/token",params:{grant_type:"refresh_token",refresh_token:e}})}async mount(t){if(this.el=typeof t=="string"?document.querySelector(t):t,!this.el)return;this.init(),this.textarea.placeholder="\u4F7F\u7528 gitee \u767B\u5F55\u53D1\u5E03\u8BC4\u8BBA",this.el.classList.add(c.b()),this.el.innerHTML="",this.textarea.classList.add(c.e("textarea")),this.textarea.oninput=()=>{this.userInfo&&(this.button.disabled=!this.textarea.value)},this.el.appendChild(this.textarea);const e=document.createElement("div");e.className=c.e("login"),this.button.innerHTML=this.userInfo?"\u53D1\u8868\u8BC4\u8BBA":"\u4F7F\u7528 Gitee \u767B\u5F55",this.button.onclick=()=>{this.userInfo?this.publish.call(this):this.login.call(this)},e.appendChild(this.button),this.el.append(e)}async getList(){var t,e,s,o;const n=await l({url:"/api/v5/search/issues",params:{access_token:(t=this.userInfo)==null?void 0:t.access_token,q:`${this.options.prefix}${document.title}`,per_page:1,repo:this.options.owner+"/"+this.options.repo}});if(((e=n[0])==null?void 0:e.title)!==`${this.options.prefix}${document.title}`){const u=await l({method:"post",url:`/api/v5/repos/${this.options.owner}/issues`,data:{access_token:(s=this.userInfo)==null?void 0:s.access_token,repo:this.options.repo,title:`${this.options.prefix}${document.title}`,body:location.href}});this.number=u.number}else this.number=n[0].number;this.list=await l({url:`/api/v5/repos/${this.options.owner}/${this.options.repo}/issues/${this.number}/comments`,params:{access_token:(o=this.userInfo)==null?void 0:o.access_token}}),this.el&&(this.ul.classList.add(c.e("ul")),this.el.appendChild(this.ul),this.ul.innerHTML="",this.renderList(this.list.splice(0,6)),document.addEventListener("scroll",this.onScroll.bind(this)))}renderList(t){let e="";t.forEach(s=>{e+=`
      <li>
        <div class="user">
          <a href="${s.user.html_url}" target="_blank">
            <img
              src="${s.user.avatar_url}"
              alt=""
            />
            <p class="name">${s.user.name}</p>
          </a>
        </div>
        <div class="body">
          <div class="info">${s.body}</div>
          <time>${this.formatTime(s.updated_at)}</time>
        </div>
      </li>
      `}),this.ul.innerHTML+=e}onScroll(){var t;const e=document.documentElement;e.scrollHeight-e.scrollTop-e.clientHeight<20&&((t=this.list)!=null&&t.length?this.renderList(this.list.splice(0,6)):document.removeEventListener("scroll",this.onScroll))}formatTime(t){const e=new Date(t),s=o=>String(o).padStart(2,"0");return`${s(e.getFullYear())}-${s(e.getMonth()+1)}-${s(e.getDate())} ${s(e.getHours())}:${s(e.getMinutes())}:${s(e.getSeconds())}`}async publish(){var t;if(!this.textarea.value)return;const e=await l({method:"post",url:`/api/v5/repos/${this.options.owner}/${this.options.repo}/issues/${this.number}/comments`,data:{access_token:(t=this.userInfo)==null?void 0:t.access_token,body:this.textarea.value}});this.textarea.value="",this.renderList([e])}}const I={class:"vp-doc"},T=h("h2",{id:"\u8BC4\u8BBA",tabindex:"-1"},[g(" \u8BC4\u8BBA "),h("a",{class:"header-anchor",href:"#\u8BC4\u8BBA","aria-hidden":"true"}," # ")],-1),S={__name:"Comment",setup(i){const{Comment:t}=L,e=p(null),s="ffd7cb7605068bcadd036f242f3d17f28bb23bd29c7fbb780413b281557f651b",o="b185210e513821c9126fcf24c4d7708fe6043e4048febd36d0e168d69a16d091";let n=null;return f(()=>{n=new t({client_id:s,client_secret:o,owner:"gd771747384",repo:"gd-accbuild-template",prefix:"gd-accbuild-template"}),n.mount(e.value),b(()=>{n&&(n==null||n.getList())})}),(u,E)=>(_(),v("div",I,[T,h("div",{ref_key:"commentRef",ref:e},null,512)]))}},D=m(S,[["__file","Comment.vue"]]);export{D as default};
