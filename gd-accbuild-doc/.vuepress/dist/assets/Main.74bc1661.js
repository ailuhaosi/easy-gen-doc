var d=Object.defineProperty;var m=(i,e,t)=>e in i?d(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var n=(i,e,t)=>(m(i,typeof e!="symbol"?e+"":e,t),t);import{a as p}from"./axios.4378cf49.js";import{_ as f}from"./_plugin-vue_export-helper.cdc0426e.js";import{g as _,h as b,n as g,o as $,c as x,a as u,d as v}from"./app.6be432f4.js";const a=(i,e="",t="",s="")=>(e&&(i+=`-${e}`),t&&(i+=`__${t}`),s&&(i+=`--${s}`),i),k=i=>({b:(e="")=>a(i,e),e:(e="")=>e?a(i,"",e):"",m:(e="")=>e?a(i,"","",e):"",be:(e="",t="")=>e&&t?a(i,e,t):"",bm:(e="",t="")=>e&&t?a(i,e,"",t):"",em:(e="",t="")=>e&&t?a(i,"",e,t):"",bem:(e="",t="",s="")=>e&&t&&s?a(i,e,t,s):"",is:(e,t)=>t?`is-${e}`:""}),w=i=>{const e=`k-${i}`;return k(e)},l=w("comment"),L=p.create({baseURL:"https://gitee.com/"}),c=async i=>{const{data:e}=await L(i);return e};class y{constructor(e){n(this,"userInfo",null);n(this,"el",null);n(this,"textarea",document.createElement("textarea"));n(this,"button",document.createElement("button"));n(this,"ul",document.createElement("ul"));n(this,"list",[]);n(this,"number","");this.options=e}async init(){var s,o,r;this.textarea=document.createElement("textarea"),this.ul=document.createElement("ul"),this.button=document.createElement("button"),this.list=[],this.number="";const e=(r=(o=(s=location.search.match(/code=[^&]+/))==null?void 0:s[0])==null?void 0:o.split("="))==null?void 0:r[1];console.log(e,"\u521D\u59CB\u5316code"),e&&await this.getToken(e);const t=JSON.parse(localStorage.getItem("comment"));if(!t){!e&&await this.getList();return}+new Date(t.expires_in+t.created_at)*1e3>Date.now()?(this.userInfo=t,await this.getList()):+new Date(t.expires_in+t.created_at)*1e3+864e5>Date.now()&&await this.refreshToken()}getRedirectUrl(){return localStorage.getItem("RedirectUrl")}login(){location.href=`https://gitee.com/oauth/authorize?client_id=${this.options.client_id}&redirect_uri=${this.getRedirectUrl()}&response_type=code`}async getToken(e){console.log(e,"\u6253\u5370code===");const t=await c({method:"post",url:"/oauth/token",params:{grant_type:"authorization_code",code:e,client_id:this.options.client_id,redirect_uri:this.getRedirectUrl()},data:{client_secret:this.options.client_secret}});history.pushState({},"",location.href.replace(location.search,"")),localStorage.setItem("comment",JSON.stringify(t)),this.userInfo=t,this.button.innerHTML=this.userInfo?"\u53D1\u8868\u8BC4\u8BBA":"\u4F7F\u7528 Gitee \u767B\u5F55",this.button.disabled=!!this.userInfo,await this.getList()}async refreshToken(){var t;const e=(t=this.userInfo)==null?void 0:t.refresh_token;localStorage.removeItem("comment"),await c({url:"/oauth/token",params:{grant_type:"refresh_token",refresh_token:e}})}async mount(e){if(this.el=typeof e=="string"?document.querySelector(e):e,!this.el)return;this.init(),this.textarea.placeholder="\u4F7F\u7528 gitee \u767B\u5F55\u53D1\u5E03\u8BC4\u8BBA",this.el.classList.add(l.b()),this.el.innerHTML="",this.textarea.classList.add(l.e("textarea")),this.textarea.oninput=()=>{this.userInfo&&(this.button.disabled=!this.textarea.value)},this.el.appendChild(this.textarea);const t=document.createElement("div");t.className=l.e("login"),this.button.innerHTML=this.userInfo?"\u53D1\u8868\u8BC4\u8BBA":"\u4F7F\u7528 Gitee \u767B\u5F55",this.button.onclick=()=>{localStorage.setItem("RedirectUrl",location.origin+location.pathname),this.userInfo?this.publish.call(this):this.login.call(this)},t.appendChild(this.button),this.el.append(t)}async getList(){var t,s,o,r;const e=await c({url:"/api/v5/search/issues",params:{access_token:(t=this.userInfo)==null?void 0:t.access_token,q:`${this.options.prefix}${document.title}`,per_page:1,repo:this.options.owner+"/"+this.options.repo}});if(((s=e[0])==null?void 0:s.title)!==`${this.options.prefix}${document.title}`){const h=await c({method:"post",url:`/api/v5/repos/${this.options.owner}/issues`,data:{access_token:(o=this.userInfo)==null?void 0:o.access_token,repo:this.options.repo,title:`${this.options.prefix}${document.title}`,body:location.href}});this.number=h.number}else this.number=e[0].number;this.list=await c({url:`/api/v5/repos/${this.options.owner}/${this.options.repo}/issues/${this.number}/comments`,params:{access_token:(r=this.userInfo)==null?void 0:r.access_token}}),this.el&&(this.ul.classList.add(l.e("ul")),this.el.appendChild(this.ul),this.ul.innerHTML="",this.renderList(this.list.splice(0,6)),document.addEventListener("scroll",this.onScroll.bind(this)))}renderList(e){let t="";e.forEach(s=>{t+=`
      <li>
        <div class="user">
          <a href="${s.user.html_url}" target="_blank">
            <img
              src="${s.user.avatar_url}"
              alt=""
            />
            <p class="name">${s.user.name}</p>
          </a>
        </div>
        <div class="body">
          <div class="info">${s.body}</div>
          <time>${this.formatTime(s.updated_at)}</time>
        </div>
      </li>
      `}),this.ul.innerHTML+=t}onScroll(){var t;const e=document.documentElement;e.scrollHeight-e.scrollTop-e.clientHeight<20&&((t=this.list)!=null&&t.length?this.renderList(this.list.splice(0,6)):document.removeEventListener("scroll",this.onScroll))}formatTime(e){const t=new Date(e),s=o=>String(o).padStart(2,"0");return`${s(t.getFullYear())}-${s(t.getMonth()+1)}-${s(t.getDate())} ${s(t.getHours())}:${s(t.getMinutes())}:${s(t.getSeconds())}`}async publish(){var t;if(!this.textarea.value)return;const e=await c({method:"post",url:`/api/v5/repos/${this.options.owner}/${this.options.repo}/issues/${this.number}/comments`,data:{access_token:(t=this.userInfo)==null?void 0:t.access_token,body:this.textarea.value}});this.textarea.value="",this.renderList([e])}}const I={class:"vp-doc"},B=u("h2",{id:"\u8BC4\u8BBA",tabindex:"-1"},[v(" \u8BC4\u8BBA "),u("a",{class:"header-anchor",href:"#\u8BC4\u8BBA","aria-hidden":"true"}," # ")],-1),S={__name:"Main",setup(i){const e=_(null),t="ffd7cb7605068bcadd036f242f3d17f28bb23bd29c7fbb780413b281557f651b",s="b185210e513821c9126fcf24c4d7708fe6043e4048febd36d0e168d69a16d091";let o=null;return b(()=>{o=new y({client_id:t,client_secret:s,owner:"gd771747384",repo:"gd-accbuild-template",prefix:"gd-accbuild-template"}),o.mount(e.value),g(()=>{o&&(o==null||o.getList())})}),(r,h)=>($(),x("div",I,[B,u("div",{ref_key:"commentRef",ref:e},null,512)]))}},F=f(S,[["__file","Main.vue"]]);export{F as default};
