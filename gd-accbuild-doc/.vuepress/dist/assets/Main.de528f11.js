var d=Object.defineProperty;var m=(i,t,e)=>t in i?d(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var o=(i,t,e)=>(m(i,typeof t!="symbol"?t+"":t,e),e);import{a as p}from"./axios.4378cf49.js";import{_ as f}from"./_plugin-vue_export-helper.cdc0426e.js";import{g as _,h as b,n as g,o as $,c as x,a as u,d as v}from"./app.cd7599f1.js";const a=(i,t="",e="",s="")=>(t&&(i+=`-${t}`),e&&(i+=`__${e}`),s&&(i+=`--${s}`),i),k=i=>({b:(t="")=>a(i,t),e:(t="")=>t?a(i,"",t):"",m:(t="")=>t?a(i,"","",t):"",be:(t="",e="")=>t&&e?a(i,t,e):"",bm:(t="",e="")=>t&&e?a(i,t,"",e):"",em:(t="",e="")=>t&&e?a(i,"",t,e):"",bem:(t="",e="",s="")=>t&&e&&s?a(i,t,e,s):"",is:(t,e)=>e?`is-${t}`:""}),w=i=>{const t=`k-${i}`;return k(t)},l=w("comment"),L=p.create({baseURL:"https://gitee.com/"}),c=async i=>{const{data:t}=await L(i);return t};class y{constructor(t){o(this,"userInfo",null);o(this,"el",null);o(this,"textarea",document.createElement("textarea"));o(this,"button",document.createElement("button"));o(this,"ul",document.createElement("ul"));o(this,"list",[]);o(this,"number","");this.options=t}async init(){var s,n,r;this.textarea=document.createElement("textarea"),this.ul=document.createElement("ul"),this.button=document.createElement("button"),this.list=[],this.number="";const t=(r=(n=(s=location.search.match(/code=[^&]+/))==null?void 0:s[0])==null?void 0:n.split("="))==null?void 0:r[1];t&&await this.getToken(t);const e=JSON.parse(localStorage.getItem("comment"));if(!e){!t&&await this.getList();return}+new Date(e.expires_in+e.created_at)*1e3>Date.now()?(this.userInfo=e,await this.getList()):+new Date(e.expires_in+e.created_at)*1e3+864e5>Date.now()&&await this.refreshToken()}login(){location.href=`https://gitee.com/oauth/authorize?client_id=${this.options.client_id}&redirect_uri=${location.origin}&response_type=code`}async getToken(t){const e=await c({method:"post",url:"/oauth/token",params:{grant_type:"authorization_code",code:t,client_id:this.options.client_id,redirect_uri:location.origin},data:{client_secret:this.options.client_secret}});history.pushState({},"",location.href.replace(location.search,"")),localStorage.setItem("comment",JSON.stringify(e)),this.userInfo=e,this.button.innerHTML=this.userInfo?"\u53D1\u8868\u8BC4\u8BBA":"\u4F7F\u7528 Gitee \u767B\u5F55",this.button.disabled=!!this.userInfo,await this.getList()}async refreshToken(){var e;const t=(e=this.userInfo)==null?void 0:e.refresh_token;localStorage.removeItem("comment"),await c({url:"/oauth/token",params:{grant_type:"refresh_token",refresh_token:t}})}async mount(t){if(this.el=typeof t=="string"?document.querySelector(t):t,!this.el)return;this.init(),this.textarea.placeholder="\u4F7F\u7528 gitee \u767B\u5F55\u53D1\u5E03\u8BC4\u8BBA",this.el.classList.add(l.b()),this.el.innerHTML="",this.textarea.classList.add(l.e("textarea")),this.textarea.oninput=()=>{this.userInfo&&(this.button.disabled=!this.textarea.value)},this.el.appendChild(this.textarea);const e=document.createElement("div");e.className=l.e("login"),this.button.innerHTML=this.userInfo?"\u53D1\u8868\u8BC4\u8BBA":"\u4F7F\u7528 Gitee \u767B\u5F55",this.button.onclick=()=>{this.userInfo?this.publish.call(this):this.login.call(this)},e.appendChild(this.button),this.el.append(e)}async getList(){var e,s,n,r;const t=await c({url:"/api/v5/search/issues",params:{access_token:(e=this.userInfo)==null?void 0:e.access_token,q:`${this.options.prefix}${document.title}`,per_page:1,repo:this.options.owner+"/"+this.options.repo}});if(((s=t[0])==null?void 0:s.title)!==`${this.options.prefix}${document.title}`){const h=await c({method:"post",url:`/api/v5/repos/${this.options.owner}/issues`,data:{access_token:(n=this.userInfo)==null?void 0:n.access_token,repo:this.options.repo,title:`${this.options.prefix}${document.title}`,body:location.href}});this.number=h.number}else this.number=t[0].number;this.list=await c({url:`/api/v5/repos/${this.options.owner}/${this.options.repo}/issues/${this.number}/comments`,params:{access_token:(r=this.userInfo)==null?void 0:r.access_token}}),this.el&&(this.ul.classList.add(l.e("ul")),this.el.appendChild(this.ul),this.ul.innerHTML="",this.renderList(this.list.splice(0,6)),document.addEventListener("scroll",this.onScroll.bind(this)))}renderList(t){let e="";t.forEach(s=>{e+=`
      <li>
        <div class="user">
          <a href="${s.user.html_url}" target="_blank">
            <img
              src="${s.user.avatar_url}"
              alt=""
            />
            <p class="name">${s.user.name}</p>
          </a>
        </div>
        <div class="body">
          <div class="info">${s.body}</div>
          <time>${this.formatTime(s.updated_at)}</time>
        </div>
      </li>
      `}),this.ul.innerHTML+=e}onScroll(){var e;const t=document.documentElement;t.scrollHeight-t.scrollTop-t.clientHeight<20&&((e=this.list)!=null&&e.length?this.renderList(this.list.splice(0,6)):document.removeEventListener("scroll",this.onScroll))}formatTime(t){const e=new Date(t),s=n=>String(n).padStart(2,"0");return`${s(e.getFullYear())}-${s(e.getMonth()+1)}-${s(e.getDate())} ${s(e.getHours())}:${s(e.getMinutes())}:${s(e.getSeconds())}`}async publish(){var e;if(!this.textarea.value)return;const t=await c({method:"post",url:`/api/v5/repos/${this.options.owner}/${this.options.repo}/issues/${this.number}/comments`,data:{access_token:(e=this.userInfo)==null?void 0:e.access_token,body:this.textarea.value}});this.textarea.value="",this.renderList([t])}}const B={class:"vp-doc"},I=u("h2",{id:"\u8BC4\u8BBA",tabindex:"-1"},[v(" \u8BC4\u8BBA "),u("a",{class:"header-anchor",href:"#\u8BC4\u8BBA","aria-hidden":"true"}," # ")],-1),T={__name:"Main",setup(i){const t=_(null),e="ffd7cb7605068bcadd036f242f3d17f28bb23bd29c7fbb780413b281557f651b",s="b185210e513821c9126fcf24c4d7708fe6043e4048febd36d0e168d69a16d091";let n=null;return b(()=>{n=new y({client_id:e,client_secret:s,owner:"gd771747384",repo:"gd-accbuild-template",prefix:"gd-accbuild-template"}),n.mount(t.value),g(()=>{n&&(n==null||n.getList())})}),(r,h)=>($(),x("div",B,[I,u("div",{ref_key:"commentRef",ref:t},null,512)]))}},D=f(T,[["__file","Main.vue"]]);export{D as default};
